gridApp.controller('server', 
	['$scope', 
	function($scope) {
		var _this = this;
		
		$scope.servers = [];

		$scope.$on('AUTH-OK', function(evt, data){
			_this.gatewayMeshClient = $scope.gridAppService.getClient();

			$scope.gridAppService.utils.notify('authenticated ok, listing servers...');
			$scope.refreshServers();

			var tunnelEvents = _this.gatewayMeshClient.event['websocket-tunnel'];

			// tunnelEvents.on('server/create', function(server) {
			// 	console.log('CREATE SERVER', server);
			// });

			// tunnelEvents.on('destroy/create', function(server) {
			// 	console.log('DESTROY SERVER', server);
			// });

		});

		$scope.refreshServers = function(){

			var tunnelExchange = _this.gatewayMeshClient.exchange['websocket-tunnel'];

			tunnelExchange.listServers()

			.then( function(servers) { 
				$scope.servers = servers;
				$scope.gridAppService.utils.notify('servers listed', 'success', 1500);
				
				if (servers.length > 0) {
					// always select th first server
					$scope.selectServer(servers[0])
				}
				

			})

			.catch(function(error) { 
				$scope.gridAppService.utils.notify('server listing failed', 'danger');
			});		
		}

		$scope.selectServer = function(server){
			console.log('select server', server);
			$scope.selectedServer = server;
			$scope.gridAppService.broadcast('SERVER-SELECTED', server);
		}
	}]
);
